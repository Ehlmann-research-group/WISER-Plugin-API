<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wiser.raster.dataset &#8212; Extending WISER  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://ehlmann-research-group.github.io/WISER-Plugin-API/_modules/wiser/raster/dataset.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for wiser.raster.dataset</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">osgeo</span><span class="w"> </span><span class="kn">import</span> <span class="n">osr</span><span class="p">,</span> <span class="n">gdal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.dataset_impl</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RasterDataImpl</span><span class="p">,</span>
    <span class="n">SaveState</span><span class="p">,</span>
    <span class="n">GDALRasterDataImpl</span><span class="p">,</span>
    <span class="n">PDRRasterDataImpl</span><span class="p">,</span>
    <span class="n">NumPyRasterDataImpl</span><span class="p">,</span>
    <span class="n">ENVI_GDALRasterDataImpl</span><span class="p">,</span>
    <span class="n">NetCDF_GDALRasterDataImpl</span><span class="p">,</span>
    <span class="n">GTiff_GDALRasterDataImpl</span><span class="p">,</span>
    <span class="n">PDS4_GDALRasterDataImpl</span><span class="p">,</span>
    <span class="n">JP2_GDAL_PDR_RasterDataImpl</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">RED_WAVELENGTH</span><span class="p">,</span>
    <span class="n">GREEN_WAVELENGTH</span><span class="p">,</span>
    <span class="n">BLUE_WAVELENGTH</span><span class="p">,</span>
    <span class="n">KNOWN_SPECTRAL_UNITS</span><span class="p">,</span>
    <span class="n">get_spectral_unit_from_any</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">find_band_near_wavelength</span><span class="p">,</span>
    <span class="n">normalize_ndarray</span><span class="p">,</span>
    <span class="n">can_transform_between_srs</span><span class="p">,</span>
    <span class="n">have_spatial_overlap</span><span class="p">,</span>
    <span class="n">build_band_info_from_wavelengths</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.data_cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataCache</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">wiser.gui.dataset_editor_dialog</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetEditorDialog</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">wiser.raster.serializable</span><span class="w"> </span><span class="kn">import</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">SerializedForm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">perf_counter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">wiser.raster.spectrum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spectrum</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">wiser.raster.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">RasterDataLoader</span>
<span class="n">Number</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
<span class="n">DisplayBands</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>

<span class="n">DEFAULT_MASK_VALUE</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GeographicLinkState</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">NO_LINK</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PIXEL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">SPATIAL</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pixel_coord_to_geo_coord</span><span class="p">(</span>
    <span class="n">pixel_coord</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">],</span>
    <span class="n">geo_transform</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function to translate a pixel-coordinate into a linear geographic</span>
<span class="sd">    coordinate using the geographic transform from GDAL.</span>

<span class="sd">    The geo_transform argument is a 6-tuple that specifies a 2D affine</span>
<span class="sd">    transformation, using the method exposed by GDAL.  See this URL for more</span>
<span class="sd">    details:  https://gdal.org/tutorials/geotransforms_tut.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">pixel_x</span><span class="p">,</span> <span class="n">pixel_y</span><span class="p">)</span> <span class="o">=</span> <span class="n">pixel_coord</span>
    <span class="n">geo_x</span> <span class="o">=</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">geo_y</span> <span class="o">=</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">pixel_x</span> <span class="o">*</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">pixel_y</span> <span class="o">*</span> <span class="n">geo_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">geo_x</span><span class="p">,</span> <span class="n">geo_y</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">geo_coord_to_angular_coord</span><span class="p">(</span><span class="n">geo_coord</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">],</span> <span class="n">spatial_ref</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function to translate a linear geographic coordinate into an</span>
<span class="sd">    angular (lat, lon) geographic coordinate using the spatial-reference system</span>
<span class="sd">    from GDAL.</span>

<span class="sd">    See this URL for more details:  https://gdal.org/tutorials/osr_api_tut.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">geo_x</span><span class="p">,</span> <span class="n">geo_y</span><span class="p">)</span> <span class="o">=</span> <span class="n">geo_coord</span>
    <span class="n">ang_spatial_ref</span> <span class="o">=</span> <span class="n">spatial_ref</span><span class="o">.</span><span class="n">CloneGeogCS</span><span class="p">()</span>
    <span class="n">coord_xform</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">CoordinateTransformation</span><span class="p">(</span><span class="n">spatial_ref</span><span class="p">,</span> <span class="n">ang_spatial_ref</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord_xform</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">(</span><span class="n">geo_x</span><span class="p">,</span> <span class="n">geo_y</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">reference_pixel_to_target_pixel_ds</span><span class="p">(</span>
    <span class="n">reference_pixel</span><span class="p">,</span>
    <span class="n">reference_dataset</span><span class="p">:</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">,</span>
    <span class="n">target_dataset</span><span class="p">:</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">,</span>
    <span class="n">link_state</span><span class="p">:</span> <span class="n">GeographicLinkState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">reference_pixel</span>
    <span class="k">if</span> <span class="n">reference_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">target_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">link_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_state</span> <span class="o">=</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">determine_link_state</span><span class="p">(</span><span class="n">reference_dataset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">link_state</span> <span class="o">==</span> <span class="n">GeographicLinkState</span><span class="o">.</span><span class="n">NO_LINK</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">link_state</span> <span class="o">==</span> <span class="n">GeographicLinkState</span><span class="o">.</span><span class="n">PIXEL</span><span class="p">:</span>
        <span class="c1"># Pixel links mean the datasets have the same width and height</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">link_state</span> <span class="o">==</span> <span class="n">GeographicLinkState</span><span class="o">.</span><span class="n">SPATIAL</span><span class="p">:</span>
        <span class="n">geo_coords</span> <span class="o">=</span> <span class="n">reference_dataset</span><span class="o">.</span><span class="n">to_geographic_coords</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="n">transformed_center</span> <span class="o">=</span> <span class="n">target_dataset</span><span class="o">.</span><span class="n">geo_to_pixel_coords</span><span class="p">(</span><span class="n">geo_coords</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">transformed_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">transformed_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uknown dataset link state: </span><span class="si">{</span><span class="n">link_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BandStats</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the statistics for a given band in a data set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_index</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">=</span> <span class="n">band_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_value</span> <span class="o">=</span> <span class="n">min_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_value</span> <span class="o">=</span> <span class="n">max_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the 0-based index of the band in the spectral data set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the cached minimum value in the band.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the cached maximum value in the band.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_value</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BandStats[index=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="si">}</span><span class="s2">, min=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_value</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_value</span><span class="si">}</span><span class="s2">]&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dict_list_equal</span><span class="p">(</span>
    <span class="n">a</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">ignore_keys</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two lists of dictionaries for equality, ignoring specific keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        a, b: The two lists of dictionaries to compare.</span>
<span class="sd">        ignore_keys: Iterable of string keys to ignore during comparison.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if equal (ignoring those keys), False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Ensure same order (if order matters). If not, sort by index or keys.</span>
    <span class="k">for</span> <span class="n">da</span><span class="p">,</span> <span class="n">db</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="c1"># Remove ignored keys from shallow copies</span>
        <span class="n">da_filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">}</span>
        <span class="n">db_filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore_keys</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">da_filtered</span> <span class="o">!=</span> <span class="n">db_filtered</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SpatialMetadata</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">geo_transform</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">wkt_spatial_reference</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">geo_transform</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">geo_transform</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;geo_transform must be a tuple of length 6, got </span><span class="si">{</span><span class="n">geo_transform</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">wkt_spatial_reference</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">wkt_spatial_reference</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;wkt_spatial_reference must be a string or None, got </span><span class="si">{</span><span class="n">wkt_spatial_reference</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span> <span class="o">=</span> <span class="n">geo_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span> <span class="o">=</span> <span class="n">wkt_spatial_reference</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_geo_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_spatial_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">]:</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="p">:</span>
            <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">srs</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;SpatialMetadata&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_geo_transform</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_wkt_spatial_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SpatialMetadata[geo_transform=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;spatial_ref=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;wkt_spatial_reference=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subset_to_window</span><span class="p">(</span>
        <span class="n">meta</span><span class="p">:</span> <span class="s2">&quot;SpatialMetadata&quot;</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">,</span>
        <span class="n">row_min</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">row_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">col_min</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">col_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SpatialMetadata&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a new SpatialMetadata corresponding to the subwindow</span>
<span class="sd">        [row_min:row_max] x [col_min:col_max] (inclusive bounds).</span>

<span class="sd">        The new geotransform is computed using GDAL&#39;s affine model:</span>
<span class="sd">          Xgeo = GT0 + col*GT1 + row*GT2</span>
<span class="sd">          Ygeo = GT3 + col*GT4 + row*GT5</span>

<span class="sd">        For a crop starting at (row_min, col_min), only GT0 and GT3 change:</span>
<span class="sd">          GT0&#39; = GT0 + col_min*GT1 + row_min*GT2</span>
<span class="sd">          GT3&#39; = GT3 + col_min*GT4 + row_min*GT5</span>
<span class="sd">        The remaining terms (GT1, GT2, GT4, GT5) are unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            meta: Existing SpatialMetadata.</span>
<span class="sd">            dataset: An object providing get_height() and get_width().</span>
<span class="sd">            row_min, row_max, col_min, col_max: Integers (inclusive).</span>

<span class="sd">        Returns:</span>
<span class="sd">            SpatialMetadata for the cropped window (same spatial reference).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError on invalid ranges or if window is out-of-bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate inputs</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_min</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_min</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;row/col bounds must be integers.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">row_min</span> <span class="o">&gt;</span> <span class="n">row_max</span> <span class="ow">or</span> <span class="n">col_min</span> <span class="o">&gt;</span> <span class="n">col_max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;min must be &lt;= max for rows and columns.&quot;</span><span class="p">)</span>

        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_height</span><span class="p">())</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_width</span><span class="p">())</span>

        <span class="c1"># We subtract 1 here because row_max and col_max had a 1 added to them to make their</span>
        <span class="c1"># original value be retained because getting bands in the image is exclusive.</span>
        <span class="k">if</span> <span class="n">row_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">col_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">row_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">height</span> <span class="ow">or</span> <span class="n">col_max</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Window out of bounds: height </span><span class="si">{</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">, width </span><span class="si">{</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but got rows [</span><span class="si">{</span><span class="n">row_min</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">row_max</span><span class="si">}</span><span class="s2">], cols [</span><span class="si">{</span><span class="n">col_min</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">col_max</span><span class="si">}</span><span class="s2">].&quot;</span>
            <span class="p">)</span>

        <span class="n">GT0</span><span class="p">,</span> <span class="n">GT1</span><span class="p">,</span> <span class="n">GT2</span><span class="p">,</span> <span class="n">GT3</span><span class="p">,</span> <span class="n">GT4</span><span class="p">,</span> <span class="n">GT5</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_geo_transform</span><span class="p">()</span>

        <span class="c1"># Offset origin to the new upper-left pixel of the crop</span>
        <span class="n">new_GT0</span> <span class="o">=</span> <span class="n">GT0</span> <span class="o">+</span> <span class="n">col_min</span> <span class="o">*</span> <span class="n">GT1</span> <span class="o">+</span> <span class="n">row_min</span> <span class="o">*</span> <span class="n">GT2</span>
        <span class="n">new_GT3</span> <span class="o">=</span> <span class="n">GT3</span> <span class="o">+</span> <span class="n">col_min</span> <span class="o">*</span> <span class="n">GT4</span> <span class="o">+</span> <span class="n">row_min</span> <span class="o">*</span> <span class="n">GT5</span>

        <span class="n">new_geo_transform</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">new_GT0</span><span class="p">),</span>  <span class="c1"># x of UL corner</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">GT1</span><span class="p">),</span>  <span class="c1"># pixel width</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">GT2</span><span class="p">),</span>  <span class="c1"># row rotation</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">new_GT3</span><span class="p">),</span>  <span class="c1"># y of UL corner</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">GT4</span><span class="p">),</span>  <span class="c1"># column rotation</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">GT5</span><span class="p">),</span>  <span class="c1"># pixel height (neg for north-up)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">SpatialMetadata</span><span class="p">(</span>
            <span class="n">geo_transform</span><span class="o">=</span><span class="n">new_geo_transform</span><span class="p">,</span>
            <span class="n">wkt_spatial_reference</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_wkt_spatial_reference</span><span class="p">(),</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SpectralMetadata</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">band_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">bad_bands</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">default_display_bands</span><span class="p">:</span> <span class="n">DisplayBands</span><span class="p">,</span>
        <span class="n">num_bands</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data_ignore_value</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="n">has_wavelengths</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">wavelengths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wavelength_units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">=</span> <span class="n">band_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="n">bad_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span> <span class="o">=</span> <span class="n">default_display_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_bands</span> <span class="o">=</span> <span class="n">num_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="o">=</span> <span class="n">data_ignore_value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span> <span class="o">=</span> <span class="n">has_wavelengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span> <span class="o">=</span> <span class="n">wavelengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="o">=</span> <span class="n">wavelength_units</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_bad_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_default_display_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DisplayBands</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_num_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bands</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data_ignore_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_has_wavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavelength_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;SpectralMetadata&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;wavelength&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">band_info_equal</span> <span class="o">=</span> <span class="n">dict_list_equal</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_band_info</span><span class="p">,</span> <span class="n">ignore_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_info_equal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_band_info</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">band_info_equal</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_bad_bands</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_default_display_bands</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_bands</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_num_bands</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_data_ignore_value</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_has_wavelengths</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelengths</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_wavelengths</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_wavelength_units</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SpectralMetadata[band_info=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;bad_bands=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;default_display_bands=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;data_ignore_value=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;has_wavelengths=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">subset_by_wavelength_range</span><span class="p">(</span>
        <span class="n">meta</span><span class="p">:</span> <span class="s2">&quot;SpectralMetadata&quot;</span><span class="p">,</span>
        <span class="n">wl_min</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span>
        <span class="n">wl_max</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SpectralMetadata&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new SpectralMetadata limited to bands whose wavelengths fall within</span>
<span class="sd">        [wl_min, wl_max], inclusive. wl_min and wl_max must exactly match existing</span>
<span class="sd">        entries in `meta.get_wavelengths()` (after unit conversion to the metadata&#39;s</span>
<span class="sd">        wavelength units).</span>

<span class="sd">        Rules:</span>
<span class="sd">          - wavelengths, num_bands, band_info, bad_bands are sliced to the range</span>
<span class="sd">          - band_info[&#39;index&#39;] is re-based to start at 0</span>
<span class="sd">          - default_display_bands are shifted to the new index space; if any are</span>
<span class="sd">            out of range, default to the first 3 bands (or fewer if &lt;3 bands)</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError if metadata has no wavelengths, units are incompatible, or</span>
<span class="sd">          wl_min/wl_max do not exactly match existing wavelengths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_has_wavelengths</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subset: metadata has no wavelengths.&quot;</span><span class="p">)</span>

        <span class="n">wls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_wavelengths</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wls</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">wls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot subset: empty wavelength list.&quot;</span><span class="p">)</span>

        <span class="c1"># Determine the canonical units used by this metadata</span>
        <span class="n">meta_units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_wavelength_units</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">meta_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If units aren&#39;t recorded, infer from the first wavelength quantity</span>
            <span class="n">meta_units</span> <span class="o">=</span> <span class="n">wls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>

        <span class="c1"># Convert bounds to the metadata&#39;s units</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wl_min_c</span> <span class="o">=</span> <span class="n">wl_min</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">meta_units</span><span class="p">)</span>
            <span class="n">wl_max_c</span> <span class="o">=</span> <span class="n">wl_max</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">meta_units</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Incompatible wavelength units: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure ascending order</span>
        <span class="k">if</span> <span class="n">wl_min_c</span> <span class="o">&gt;</span> <span class="n">wl_max_c</span><span class="p">:</span>
            <span class="n">wl_min_c</span><span class="p">,</span> <span class="n">wl_max_c</span> <span class="o">=</span> <span class="n">wl_max_c</span><span class="p">,</span> <span class="n">wl_min_c</span>

        <span class="c1"># Build an array of magnitudes in the metadata unit for exact matching/slicing</span>
        <span class="n">wl_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">meta_units</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">wls</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Find exact (not fuzzy) index matches for the provided bounds</span>
        <span class="c1"># &quot;Exact&quot; here means identical float magnitudes after unit conversion.</span>
        <span class="c1"># If your stored wavelengths were parsed from strings, this should hold.</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">find_exact_idx</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">wl_vals</span> <span class="o">==</span> <span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matches</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested wavelength </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">meta_units</span><span class="si">}</span><span class="s2"> not found exactly in metadata.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">find_exact_idx</span><span class="p">(</span><span class="n">wl_min_c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">find_exact_idx</span><span class="p">(</span><span class="n">wl_max_c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;</span> <span class="n">end_idx</span><span class="p">:</span>
            <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">end_idx</span><span class="p">,</span> <span class="n">start_idx</span>

        <span class="c1"># Slice indices (inclusive of end)</span>
        <span class="n">idx_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_wls</span> <span class="o">=</span> <span class="n">wls</span><span class="p">[</span><span class="n">idx_slice</span><span class="p">]</span>
        <span class="n">new_num_bands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_wls</span><span class="p">)</span>

        <span class="c1"># Slice/adjust bad_bands (list of indices, not a mask)</span>
        <span class="n">old_bad</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">old_bad</span><span class="p">:</span>
            <span class="n">new_bad</span> <span class="o">=</span> <span class="n">old_bad</span><span class="p">[</span><span class="n">idx_slice</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_bad</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">new_num_bands</span>
        <span class="c1"># Rebuild band_info with re-based indices and consistent wavelength fields</span>
        <span class="n">old_band_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_band_info</span><span class="p">()</span>
        <span class="n">new_band_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">old_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="n">old_band_info</span><span class="p">[</span><span class="n">old_i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Re-base index to new_i</span>
            <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_i</span>

            <span class="c1"># Ensure wavelength fields match the subset quantities exactly</span>
            <span class="n">q</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">new_wls</span><span class="p">[</span><span class="n">new_i</span><span class="p">]</span>
            <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
            <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
            <span class="c1"># Preserve a stable string representation</span>
            <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;wavelength_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Keep description if present; otherwise, make a simple one</span>
            <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ob</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]:</span>
                <span class="n">ob</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">new_band_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>

        <span class="c1"># Shift/validate default display bands</span>
        <span class="n">old_display</span><span class="p">:</span> <span class="n">DisplayBands</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get_default_display_bands</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">shift_display</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">DisplayBands</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DisplayBands</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
                <span class="c1"># Shift each band by -start_idx and ensure all are within new range</span>
                <span class="n">shifted</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">start_idx</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">db</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">new_num_bands</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">shifted</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">shifted</span>  <span class="c1"># type: ignore</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">shifted_display</span> <span class="o">=</span> <span class="n">shift_display</span><span class="p">(</span><span class="n">old_display</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shifted_display</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Reset to first 3 (or fewer if not enough bands)</span>
            <span class="k">if</span> <span class="n">new_num_bands</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">new_display</span><span class="p">:</span> <span class="n">DisplayBands</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">new_num_bands</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">new_display</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">new_num_bands</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_display</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No bands  edge case; keep as empty tuple</span>
                <span class="n">new_display</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_display</span> <span class="o">=</span> <span class="n">shifted_display</span>

        <span class="c1"># Construct and return the new SpectralMetadata</span>
        <span class="k">return</span> <span class="n">SpectralMetadata</span><span class="p">(</span>
            <span class="n">band_info</span><span class="o">=</span><span class="n">new_band_info</span><span class="p">,</span>
            <span class="n">bad_bands</span><span class="o">=</span><span class="n">new_bad</span><span class="p">,</span>
            <span class="n">default_display_bands</span><span class="o">=</span><span class="n">new_display</span><span class="p">,</span>
            <span class="n">num_bands</span><span class="o">=</span><span class="n">new_num_bands</span><span class="p">,</span>
            <span class="n">data_ignore_value</span><span class="o">=</span><span class="n">meta</span><span class="o">.</span><span class="n">get_data_ignore_value</span><span class="p">(),</span>
            <span class="n">has_wavelengths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">wavelengths</span><span class="o">=</span><span class="n">new_wls</span><span class="p">,</span>
            <span class="n">wavelength_units</span><span class="o">=</span><span class="n">meta_units</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="RasterDataSet">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RasterDataSet</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A 2D raster data-set for imaging spectroscopy, possibly with many bands of</span>
<span class="sd">    data for each pixel.</span>

<span class="sd">    This class is not deep copyable. If you try to deep copy it, you will get</span>
<span class="sd">    an reference to the same object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">impl</span><span class="p">:</span> <span class="n">RasterDataImpl</span><span class="p">,</span> <span class="n">data_cache</span><span class="p">:</span> <span class="n">DataCache</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">impl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;impl cannot be None&quot;</span><span class="p">)</span>

        <span class="c1"># Unique numeric ID assigned to the data set by WISER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="p">:</span> <span class="n">RasterDataImpl</span> <span class="o">=</span> <span class="n">impl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span> <span class="o">=</span> <span class="n">data_cache</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Optional description for the raster data set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_description</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_band_unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_band_unit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_band_info</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_bad_bands</span><span class="p">()</span>

        <span class="c1"># Optional default display bands for the raster data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DisplayBands</span><span class="p">]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_default_display_bands</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_data_ignore_value</span><span class="p">()</span>

        <span class="c1"># The affine geographic transform.  Default is &quot;identity&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_geo_transform</span><span class="p">()</span>

        <span class="c1"># The Spatial Reference System for the dataset.  Only present if this</span>
        <span class="c1"># dataset is geographic.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">read_spatial_ref</span><span class="p">()</span>

        <span class="c1"># The wkt spatial reference for this dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">get_wkt_spatial_reference</span><span class="p">()</span>

        <span class="c1"># True if the dataset has wavelengths (or units that can be converted to</span>
        <span class="c1"># wavelengths) for ALL bands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_has_wavelengths</span><span class="p">()</span>

        <span class="c1"># Flag indicating whether the data set contains unsaved data.  Some</span>
        <span class="c1"># values are excluded from this, like the numeric ID, which is internal</span>
        <span class="c1"># to WISER, and varies from run to run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># A map of band index to BandStats objects, so that we can lazily</span>
        <span class="c1"># compute these values and reuse them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">BandStats</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_has_wavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;wavelength&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataCache</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="n">dirty</span>
        <span class="c1"># TODO(donnie):  Notify someone?</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span>

<div class="viewcode-block" id="RasterDataSet.get_id">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numeric ID for referring to the data set within the</span>
<span class="sd">        application.  A value of ``None`` indicates that the data-set has not</span>
<span class="sd">        yet been assigned an ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span></div>


<div class="viewcode-block" id="RasterDataSet.set_id">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.set_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets a unique numeric ID for referring to the data set within WISER.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

<div class="viewcode-block" id="RasterDataSet.get_description">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_description">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string description of the dataset that might be specified in</span>
<span class="sd">        the raster file&#39;s metadata.  A missing description is indicated by the</span>
<span class="sd">        ``None`` value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span></div>


<div class="viewcode-block" id="RasterDataSet.set_description">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.set_description">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the string description of the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_format">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_format">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string describing the type of raster data file that backs this</span>
<span class="sd">        dataset.  The file-type string will be specific to the kind of loader</span>
<span class="sd">        used to load the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_format</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_filepaths">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_filepaths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_filepaths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the paths and filenames of all files associated with this raster</span>
<span class="sd">        dataset.  This will be an empty list (not ``None``) if the data is</span>
<span class="sd">        in-memory only, e.g. because it wasn&#39;t yet saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_filepaths</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_width">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_width">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of pixels per row in the raster data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_height">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_height">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of rows of data in the raster data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.num_bands">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.num_bands">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of spectral bands in the raster data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_shape">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_shape">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the shape of the raster data set.  This is always in the order</span>
<span class="sd">        ``(num_bands, height, width)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">())</span></div>


<div class="viewcode-block" id="RasterDataSet.get_elem_type">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_elem_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_elem_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the element-type of the raster data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_elem_type</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_band_memory_size">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_band_memory_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_memory_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the approximate size of a band of this dataset.</span>
<span class="sd">        It&#39;s approximate because this doesn&#39;t account for compression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elem_type</span><span class="p">()</span><span class="o">.</span><span class="n">itemsize</span></div>


<div class="viewcode-block" id="RasterDataSet.get_memory_size">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_memory_size">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_memory_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the approximate size of this dataset.</span>
<span class="sd">        It&#39;s approximate because this doesn&#39;t account for compression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_band_memory_size</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.get_band_unit">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_band_unit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the units used for all bands&#39; wavelengths, or ``None`` if bands</span>
<span class="sd">        do not specify units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">read_band_unit</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.band_list">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.band_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">band_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a description of all bands in the data set.  The description is</span>
<span class="sd">        formulated as a list of dictionaries, where each dictionary provides</span>
<span class="sd">        details about the band.  The list of dictionaries is in the same order</span>
<span class="sd">        as the bands in the raster dataset, so that the dictionary at index i in</span>
<span class="sd">        the list describes band i.</span>

<span class="sd">        Dictionaries may (but are not required to) contain these keys:</span>

<span class="sd">        *   &#39;index&#39; - the integer index of the band (always present)</span>
<span class="sd">        *   &#39;description&#39; - the string description of the band</span>
<span class="sd">        *   &#39;wavelength&#39; - a value-with-units for the spectral wavelength of</span>
<span class="sd">            the band.  astropy.units is used to represent the values-with-units.</span>
<span class="sd">        *   &#39;wavelength_str&#39; - the string version of the band&#39;s wavelength</span>
<span class="sd">        *   &#39;wavelength_units&#39; - the string version of the band&#39;s</span>
<span class="sd">            wavelength-units value</span>

<span class="sd">        Note that since both lists and dictionaries are mutable, care must be</span>
<span class="sd">        taken not to mutate the return-value of this method, as it will affect</span>
<span class="sd">        the data-set&#39;s internal state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span></div>


<div class="viewcode-block" id="RasterDataSet.has_wavelengths">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.has_wavelengths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_wavelengths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``True`` if all bands specify a wavelength (or some other unit</span>
<span class="sd">        that can be converted to wavelength); otherwise, returns ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span></div>


<div class="viewcode-block" id="RasterDataSet.default_display_bands">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.default_display_bands">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_display_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DisplayBands</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple of integer indexes, specifying the default bands for</span>
<span class="sd">        display.  If the list has 3 values, these are displayed using the red,</span>
<span class="sd">        green and blue channels of an image.  If the list has 1 value, the band</span>
<span class="sd">        is displayed as grayscale.</span>

<span class="sd">        If the raster data specifies no default bands, the return value is</span>
<span class="sd">        ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_display_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DisplayBands</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bands must contain either 1 or 3 integer values; got </span><span class="si">{</span><span class="n">bands</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bands must contain either 1 or 3 integer values; got </span><span class="si">{</span><span class="n">bands</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span>

<div class="viewcode-block" id="RasterDataSet.get_data_ignore_value">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_data_ignore_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data_ignore_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number that indicates a value to be ignored in the dataset.</span>
<span class="sd">        If this value is unknown or unspecified in the data, ``None`` is</span>
<span class="sd">        returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_data_ignore_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="o">=</span> <span class="n">ignore_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span>

<div class="viewcode-block" id="RasterDataSet.get_bad_bands">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_bad_bands">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bad_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a &quot;bad band list&quot; as a list of 0 or 1 integer values, with the</span>
<span class="sd">        same number of elements as the total number of bands in the dataset.</span>
<span class="sd">        A value of 0 means the band is &quot;bad,&quot; and a value of 1 means the band is</span>
<span class="sd">        &quot;good.&quot;</span>

<span class="sd">        The returned list is a copy of the internal list; mutation on the</span>
<span class="sd">        returned list will not affect the raster data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">set_bad_bands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bad_bands</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_bands</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Raster data set has </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span><span class="si">}</span><span class="s2"> bands; &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;specified bad-band list has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bad_bands</span><span class="p">)</span><span class="si">}</span><span class="s2"> values&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">bad_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bad_bands</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RasterDataSet.get_image_data">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_image_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 3D array of the entire image cube.</span>

<span class="sd">        The numpy array is configured such that the pixel (x, y) values of band</span>
<span class="sd">        b are at element array[b][y][x].</span>

<span class="sd">        If the data-set has a &quot;data ignore value&quot; and filter_data_ignore_value</span>
<span class="sd">        is also set to True, the array will be filtered such that any element</span>
<span class="sd">        with the &quot;data ignore value&quot; will be filtered to NaN.  Note that this</span>
<span class="sd">        filtering will impact performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="o">.</span><span class="n">get_computation_cache</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">filter_data_ignore_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">add_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_image_data_subset">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_image_data_subset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_data_subset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">band</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dy</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dband</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">filter_data_ignore_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a 3D numpy array of values specified starting at x, y, and band</span>
<span class="sd">        and going until x+dx, y+dy, band+dband. The d variables are exclusive.</span>

<span class="sd">        Data returned is in format arr[b][y][x]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># See if image data is already in the cache, if it is we just splice</span>

        <span class="c1"># If not then we ask the impl type for the data. We don&#39;t store it in the cache.</span>
        <span class="c1"># We want to mak sure the dimension is 3D, cause it could be a minimum</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="o">.</span><span class="n">get_computation_cache</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_image_data_subset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dband</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">filter_data_ignore_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_band_data">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_band_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 2D array of the specified band&#39;s data.  The first band</span>
<span class="sd">        is at index 0.</span>

<span class="sd">        The numpy array is configured such that the pixel (x, y) values are at</span>
<span class="sd">        element array[y][x].</span>

<span class="sd">        If the data-set has a &quot;data ignore value&quot; and filter_data_ignore_value</span>
<span class="sd">        is also set to True, the array will be filtered such that any element</span>
<span class="sd">        with the &quot;data ignore value&quot; will be filtered to NaN.  Note that this</span>
<span class="sd">        filtering will impact performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="o">.</span><span class="n">get_computation_cache</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_index</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_band_data</span><span class="p">(</span><span class="n">band_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filter_data_ignore_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">add_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_band_stats</span><span class="p">(</span><span class="n">band_index</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_band_data_normalized">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_band_data_normalized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_data_normalized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">band_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">band_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filter_data_ignore_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 2D array of the specified band&#39;s data. The first band</span>
<span class="sd">        is at index 0.</span>

<span class="sd">        The numpy array is configured such that the pixel (x, y) values are at</span>
<span class="sd">        element array[y][x].</span>

<span class="sd">        If the data-set has a &quot;data ignore value&quot; and filter_data_ignore_value</span>
<span class="sd">        is also set to True, the array will be filtered such that any element</span>
<span class="sd">        with the &quot;data ignore value&quot; will be filtered to NaN.  Note that this</span>
<span class="sd">        filtering will impact performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="o">.</span><span class="n">get_computation_cache</span><span class="p">()</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_index</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_band_data</span><span class="p">(</span><span class="n">band_index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">filter_data_ignore_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>

            <span class="c1"># Must get min after making it a masked array</span>
            <span class="k">if</span> <span class="n">band_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">:</span>
                <span class="n">band_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span><span class="o">.</span><span class="n">get_min</span><span class="p">()</span>
                <span class="n">band_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span><span class="o">.</span><span class="n">get_max</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

                <span class="n">filtered_arr</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="k">if</span> <span class="n">has_inf</span><span class="p">:</span>
                    <span class="n">filtered_arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">arr</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">band_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">band_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">filtered_arr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">band_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">band_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">filtered_arr</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">BandStats</span><span class="p">(</span><span class="n">band_index</span><span class="p">,</span> <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">mask</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">normalize_ndarray</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span><span class="p">)</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">normalize_ndarray</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">[(</span><span class="n">band_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">stats</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_cache</span><span class="p">:</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">add_cache_item</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Array returned from get_band_data_normalized does not have 2 dimensions. Instead has </span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">ndim</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.sample_band_data">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.sample_band_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_band_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sample_factor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 2D array of the specified band&#39;s data.  The first band</span>
<span class="sd">        is at index 0.</span>

<span class="sd">        The numpy array is configured such that the pixel (x, y) values are at</span>
<span class="sd">        element array[y][x].</span>

<span class="sd">        If the data-set has a &quot;data ignore value&quot; and filter_data_ignore_value</span>
<span class="sd">        is also set to True, the array will be filtered such that any element</span>
<span class="sd">        with the &quot;data ignore value&quot; will be filtered to NaN.  Note that this</span>
<span class="sd">        filtering will impact performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">sample_band_data</span><span class="p">(</span><span class="n">band_index</span><span class="p">,</span> <span class="n">sample_factor</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_data_ignore_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_multiple_band_data">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_multiple_band_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_multiple_band_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">filter_data_ignore_value</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 3D array of the specified images band data for all pixels in those</span>
<span class="sd">        bands.</span>
<span class="sd">        The numpy array is configured such that the pixel (x, y) for band b values are at</span>
<span class="sd">        element array[b][y][x].</span>
<span class="sd">        If the data-set has a &quot;data ignore value&quot; and filter_data_ignore_value</span>
<span class="sd">        is also set to True, the array will be filtered such that any element</span>
<span class="sd">        with the &quot;data ignore value&quot; will be filtered to NaN.  Note that this</span>
<span class="sd">        filtering will impact performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_multiple_band_data</span><span class="p">(</span><span class="n">band_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_data_ignore_value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_band_stats">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_band_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">band</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns statistics of the specified band&#39;s data, wrapped in a</span>
<span class="sd">        :class:`BandStats` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">band_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_band_data</span><span class="p">(</span><span class="n">band_index</span><span class="p">)</span>

            <span class="n">has_inf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">band</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="n">filtered_band</span> <span class="o">=</span> <span class="n">band</span>
            <span class="k">if</span> <span class="n">has_inf</span><span class="p">:</span>
                <span class="n">filtered_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">band</span><span class="p">)]</span>

            <span class="n">band_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">filtered_band</span><span class="p">)</span>
            <span class="n">band_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">filtered_band</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">BandStats</span><span class="p">(</span><span class="n">band_index</span><span class="p">,</span> <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
        <span class="k">return</span> <span class="n">stats</span></div>


<div class="viewcode-block" id="RasterDataSet.get_all_bands_at">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_all_bands_at">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_bands_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filter_bad_values</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 1D array of the values of all bands at the specified</span>
<span class="sd">        (x, y) coordinate in the raster data.</span>

<span class="sd">        If filter_bad_values is set to True, bands that are marked as &quot;bad&quot; in</span>
<span class="sd">        the metadata will be set to NaN, and bands with the &quot;data ignore value&quot;</span>
<span class="sd">        will also be set to NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_all_bands_at</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_bad_values</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Band is marked &quot;bad&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_MASK_VALUE</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">):</span>
                    <span class="c1"># Band has the &quot;data ignore&quot; value</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_MASK_VALUE</span>

        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_all_bands_at_rect">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_all_bands_at_rect">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_bands_at_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">filter_bad_values</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 2D array of the values of all bands at the specified</span>
<span class="sd">        rectangle in the raster data.</span>
<span class="sd">        If filter_bad_values is set to True, bands that are marked as &quot;bad&quot; in</span>
<span class="sd">        the metadata will be set to NaN, and bands with the &quot;data ignore value&quot;</span>
<span class="sd">        will also be set to NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_all_bands_at_rect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filter_bad_values</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># if np.issubdtype(arr.dtype, np.integer):</span>
            <span class="c1">#     arr = arr.astype(np.float32, copy=False)</span>
            <span class="c1"># Make mask for the bad band values</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">())</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)),</span> <span class="s2">&quot;Bad bands mask contains values other than 0 or 1&quot;</span>
            <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="s2">&quot;Length of mask does not match number of spectra&quot;</span>

            <span class="c1"># In the mask, 1 means keep and 0 means get rid of, I use XOR with 1 to reverse this</span>
            <span class="c1"># because np&#39;s mask operation (arr[mask]) would switch all the values where the mask is 1</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mask</span> <span class="o">^</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                        <span class="n">arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_MASK_VALUE</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask_ignore_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">arr</span><span class="p">[</span><span class="n">mask_ignore_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">arr</span><span class="p">[</span><span class="n">mask_ignore_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_MASK_VALUE</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="RasterDataSet.get_geo_transform">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_geo_transform">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_geo_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the geographic transform for this dataset as a 6-tuple of</span>
<span class="sd">        floats.  The geographic transform is used to map pixel coordinates to</span>
<span class="sd">        linear geographic coordinates, and is always an affine transformation.</span>
<span class="sd">        To map linear geographic coordinates into angular geographic</span>
<span class="sd">        coordinates, see the ``get_spatial_ref()`` method.</span>

<span class="sd">        This value is always present; if the underlying data file doesn&#39;t</span>
<span class="sd">        specify a geographic transform then an identity transformation</span>
<span class="sd">        is returned.</span>

<span class="sd">        See https://gdal.org/tutorials/geotransforms_tut.html for more details</span>
<span class="sd">        on how to interpret this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_wkt_spatial_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span>

<div class="viewcode-block" id="RasterDataSet.get_spatial_ref">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_spatial_ref">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_spatial_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the GDAL spatial reference system used for this dataset, or</span>
<span class="sd">        ``None`` if the dataset doesn&#39;t have a spatial reference system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">has_geographic_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="RasterDataSet.cache_band_stats">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.cache_band_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cache_band_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores the band stats in this dataset&#39;s cache for band stats</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">:</span>
            <span class="n">band_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="n">band_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="n">band_stats</span> <span class="o">=</span> <span class="n">BandStats</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">band_min</span><span class="p">,</span> <span class="n">band_max</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_band_stats</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_stats</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_geographic_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_coord</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">geo_coord</span> <span class="o">=</span> <span class="n">pixel_coord_to_geo_coord</span><span class="p">(</span><span class="n">pixel_coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">geo_coord</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_angular_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_coord</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">geo_coord</span> <span class="o">=</span> <span class="n">pixel_coord_to_geo_coord</span><span class="p">(</span><span class="n">pixel_coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">)</span>
        <span class="n">ang_coord</span> <span class="o">=</span> <span class="n">geo_coord_to_angular_coord</span><span class="p">(</span><span class="n">geo_coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ang_coord</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">geo_to_pixel_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geo_coords</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">inv_geo_transform</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">InvGeoTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inv_geo_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Geo transform of dataset is not invertible!&quot;</span><span class="p">)</span>

        <span class="n">origin_px</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">x_rotation</span><span class="p">,</span> <span class="n">origin_py</span><span class="p">,</span> <span class="n">y_rotation</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">inv_geo_transform</span>
        <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">geo_coords</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">origin_px</span> <span class="o">+</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">x_rotation</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">origin_py</span> <span class="o">+</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">y_rotation</span> <span class="o">+</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">height</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">px</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">py</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># +0.5 for rounding</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">geo_to_pixel_coords_exact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geo_coords</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">inv_geo_transform</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">InvGeoTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inv_geo_transform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Geo transform of dataset is not invertible!&quot;</span><span class="p">)</span>

        <span class="n">origin_px</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">x_rotation</span><span class="p">,</span> <span class="n">origin_py</span><span class="p">,</span> <span class="n">y_rotation</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">inv_geo_transform</span>
        <span class="n">gx</span><span class="p">,</span> <span class="n">gy</span> <span class="o">=</span> <span class="n">geo_coords</span>
        <span class="n">px</span> <span class="o">=</span> <span class="n">origin_px</span> <span class="o">+</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">x_rotation</span>
        <span class="n">py</span> <span class="o">=</span> <span class="n">origin_py</span> <span class="o">+</span> <span class="n">gx</span> <span class="o">*</span> <span class="n">y_rotation</span> <span class="o">+</span> <span class="n">gy</span> <span class="o">*</span> <span class="n">height</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">)</span>  <span class="c1"># +0.5 for rounding</span>

<div class="viewcode-block" id="RasterDataSet.is_pixel_in_image_bounds">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.is_pixel_in_image_bounds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_pixel_in_image_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks to see if the pixel is in the bounds of the image.</span>

<span class="sd">        The 0th index of pixel corresponds to the width (x-coordinate) and the 1st index</span>
<span class="sd">        corresponds to the height (y-coordinate). The coordinate (0, 0) is the top left</span>
<span class="sd">        most valid pixel.</span>

<span class="sd">        Args:</span>
<span class="sd">            - pixel: The pixel that we want to know is inbounds or not</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the pixel is within the bounds of the image, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pixel</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>

        <span class="c1"># Check if the pixel is within the valid coordinate range:</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span></div>


<div class="viewcode-block" id="RasterDataSet.is_spatial_coord_in_spatial_bounds">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.is_spatial_coord_in_spatial_bounds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_spatial_coord_in_spatial_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_coord</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks to see if the spatial coordinate is in the spatial bounds of the image.</span>

<span class="sd">        The 0th index of spatial_coord corresponds to the x coordinate in spatial terms,</span>
<span class="sd">        and the 1st index corresponds to the y coordinate. The spatial extent of the image is</span>
<span class="sd">        determined using self._geo_transform (as returned by GDAL&#39;s GetGeoTransform) along with</span>
<span class="sd">        the image dimensions from self.get_width() (x direction) and self.get_height() (y direction).</span>

<span class="sd">        Args:</span>
<span class="sd">            - spatial_coord: The spatial coordinate that we want to know is inbounds or not</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the spatial coordinate is within the spatial bounds of the image, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Retrieve the geo transform tuple</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span>
        <span class="n">origin_x</span><span class="p">,</span> <span class="n">pixel_width</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">origin_y</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">pixel_height</span> <span class="o">=</span> <span class="n">gt</span>

        <span class="c1"># Get the image dimensions in pixels</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>

        <span class="c1"># Compute the spatial coordinate of the image&#39;s opposite corner.</span>
        <span class="c1"># For the x direction:</span>
        <span class="n">end_x</span> <span class="o">=</span> <span class="n">origin_x</span> <span class="o">+</span> <span class="n">pixel_width</span> <span class="o">*</span> <span class="n">width</span>
        <span class="c1"># For the y direction:</span>
        <span class="n">end_y</span> <span class="o">=</span> <span class="n">origin_y</span> <span class="o">+</span> <span class="n">pixel_height</span> <span class="o">*</span> <span class="n">height</span>

        <span class="c1"># Determine the min and max bounds in the x and y directions.</span>
        <span class="c1"># This accounts for cases where pixel_width or pixel_height might be negative.</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">origin_x</span><span class="p">,</span> <span class="n">end_x</span><span class="p">)</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">origin_x</span><span class="p">,</span> <span class="n">end_x</span><span class="p">)</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">origin_y</span><span class="p">,</span> <span class="n">end_y</span><span class="p">)</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">origin_y</span><span class="p">,</span> <span class="n">end_y</span><span class="p">)</span>

        <span class="c1"># Unpack the provided spatial coordinate.</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">spatial_coord</span>

        <span class="c1"># Check if the coordinate is within the computed spatial bounds.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">min_x</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">max_x</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">min_y</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">max_y</span><span class="p">)</span></div>


<div class="viewcode-block" id="RasterDataSet.determine_link_state">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.determine_link_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">determine_link_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeographicLinkState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests to see if the passed in dataset is compatible to link with the current dataset</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (RasterDataSet):</span>
<span class="sd">                The dataset that we want to determine our dataset&#39;s link state with</span>

<span class="sd">        Returns:</span>
<span class="sd">            GeographicLinkState: 0 is no link, 1 is pixel link, 2 is spatial link</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ds0_dim</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">())</span>
        <span class="n">ds_dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_height</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">ds_dim</span> <span class="o">==</span> <span class="n">ds0_dim</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GeographicLinkState</span><span class="o">.</span><span class="n">PIXEL</span>

        <span class="n">ds0_srs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spatial_ref</span><span class="p">()</span>

        <span class="n">ds_srs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_spatial_ref</span><span class="p">()</span>
        <span class="n">can_transform</span> <span class="o">=</span> <span class="n">can_transform_between_srs</span><span class="p">(</span><span class="n">ds0_srs</span><span class="p">,</span> <span class="n">ds_srs</span><span class="p">)</span>
        <span class="n">have_overlap</span> <span class="o">=</span> <span class="n">have_spatial_overlap</span><span class="p">(</span>
            <span class="n">ds0_srs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_geo_transform</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
            <span class="n">ds_srs</span><span class="p">,</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">get_geo_transform</span><span class="p">(),</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">get_width</span><span class="p">(),</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">ds0_srs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ds_srs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">can_transform</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">have_overlap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GeographicLinkState</span><span class="o">.</span><span class="n">NO_LINK</span>

        <span class="k">return</span> <span class="n">GeographicLinkState</span><span class="o">.</span><span class="n">SPATIAL</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">is_metadata_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spatial_metadata</span><span class="p">()</span>
        <span class="n">other_spatial_metadata</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_spatial_metadata</span><span class="p">()</span>

        <span class="n">spectral_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_metadata</span><span class="p">()</span>
        <span class="n">other_spectral_metadata</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_spectral_metadata</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">spatial_metadata</span> <span class="o">==</span> <span class="n">other_spatial_metadata</span> <span class="ow">and</span> <span class="n">spectral_metadata</span> <span class="o">==</span> <span class="n">other_spectral_metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy_metadata_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This dataset has </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span><span class="si">}</span><span class="s2"> bands; &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;source dataset has </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span><span class="si">}</span><span class="s2"> bands&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Copy across all the metadata!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">_band_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">_bad_bands</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_default_display_bands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_data_ignore_value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_has_wavelengths</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span>

<div class="viewcode-block" id="RasterDataSet.copy_spatial_metadata">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.copy_spatial_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_spatial_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">SpatialMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the spatial metadata from the SpatialMetadata object.</span>

<span class="sd">        The spatial metadata includes the geographical transform, and the</span>
<span class="sd">        spatial reference system, if the raster has one.  Any mutable values are</span>
<span class="sd">        deep-copied so that changes to the source&#39;s information do not affect</span>
<span class="sd">        this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_geo_transform</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">get_spatial_ref</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_spatial_ref</span><span class="p">()</span><span class="o">.</span><span class="n">Clone</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">get_wkt_spatial_reference</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_wkt_spatial_reference</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_spatial_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMetadata</span><span class="p">:</span>
        <span class="n">spatial_metadata</span> <span class="o">=</span> <span class="n">SpatialMetadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spatial_metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_spectral_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralMetadata</span><span class="p">:</span>
        <span class="n">wavelengths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_wavelengths</span><span class="p">():</span>
            <span class="k">assert</span> <span class="s2">&quot;wavelength&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Band info does not contain wavelength information&quot;</span>
            <span class="n">wavelengths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">band_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">:</span>
                <span class="n">wavelengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_info</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">])</span>
        <span class="n">spectral_metadata</span> <span class="o">=</span> <span class="n">SpectralMetadata</span><span class="p">(</span>
            <span class="n">band_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">,</span>
            <span class="n">bad_bands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">(),</span>
            <span class="n">default_display_bands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span><span class="p">,</span>
            <span class="n">num_bands</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">(),</span>
            <span class="n">data_ignore_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">,</span>
            <span class="n">has_wavelengths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_wavelengths</span><span class="p">(),</span>
            <span class="n">wavelengths</span><span class="o">=</span><span class="n">wavelengths</span><span class="p">,</span>
            <span class="n">wavelength_units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_band_unit</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">spectral_metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy_spectral_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">SpectralMetadata</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">band_info</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_band_info</span><span class="p">()</span>
        <span class="n">bad_bands</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">()</span>
        <span class="n">default_display_bands</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_default_display_bands</span><span class="p">()</span>
        <span class="n">data_ignore_value</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_data_ignore_value</span><span class="p">()</span>
        <span class="n">has_wavelengths</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_has_wavelengths</span><span class="p">()</span>
        <span class="n">wavelengths</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_wavelengths</span><span class="p">()</span>
        <span class="n">wavelength_units</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_wavelength_units</span><span class="p">()</span>
        <span class="c1"># There are two options here. Either we get the spectral information from the band info, or</span>
        <span class="c1"># we get it from the wavelengths</span>
        <span class="k">if</span> <span class="n">band_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">=</span> <span class="n">band_info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="n">bad_bands</span> <span class="k">if</span> <span class="n">bad_bands</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span> <span class="o">=</span> <span class="n">default_display_bands</span> <span class="k">if</span> <span class="n">default_display_bands</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">data_ignore_value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="o">=</span> <span class="n">data_ignore_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_has_wavelengths</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_wavelengths</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="s2">&quot;Even though has_wavelengths is True, wavelengths don&#39;t exist&quot;</span>
                <span class="k">assert</span> <span class="n">has_wavelengths</span> <span class="ow">and</span> <span class="n">wavelength_units</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">=</span> <span class="n">build_band_info_from_wavelengths</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">band_index</span><span class="p">,</span> <span class="n">wavelength</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">get_num_bands</span><span class="p">()):</span>
                    <span class="c1"># We don&#39;t take of -1 here because we are going from 0 in enumerate</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">band_index</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Band: </span><span class="si">{</span><span class="n">band_index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">bad_bands</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bad_bands</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_default_display_bands</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">default_display_bands</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_display_bands</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_has_wavelengths</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span>

<div class="viewcode-block" id="RasterDataSet.show_edit_dataset_dialog">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.show_edit_dataset_dialog">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_edit_dataset_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an edit dataset dialog menu. Should have a label at the top that</span>
<span class="sd">        says none of the changes persist on disk. THey only persist for this session.</span>

<span class="sd">        Should have a section under this with a label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset_edit</span> <span class="o">=</span> <span class="n">DatasetEditorDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
        <span class="n">dataset_edit</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>


<div class="viewcode-block" id="RasterDataSet.update_band_info">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.update_band_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_band_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the band information for this dataset. Updates the units and</span>
<span class="sd">        the _band_info field. These changes do not persist across sessions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_band_unit</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_wavelengths</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span>
        <span class="p">),</span> <span class="s2">&quot;Wavelengths array passed into band info isn&#39;t made of u.Quantity&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_bands</span><span class="p">(),</span> <span class="s2">&quot;Wavelengths to update band info doesn&#39;t equal num bands&quot;</span>

        <span class="n">band_info</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">band_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">band_index</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">}</span>

            <span class="n">wl_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">wl_units</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelengths</span><span class="p">[</span><span class="n">band_index</span><span class="p">]</span>

            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;wavelength_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl_str</span>  <span class="c1"># String of the value, not the units</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl_units</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavelength</span>

            <span class="n">band_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">=</span> <span class="n">band_info</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">get_save_state</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_state</span><span class="p">:</span> <span class="n">SaveState</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">set_save_state</span><span class="p">(</span><span class="n">save_state</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_subdataset_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="p">,</span> <span class="s2">&quot;_subdataset_name&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">_subdataset_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_underlying_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="p">,</span> <span class="s2">&quot;delete_dataset&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">delete_dataset</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="RasterDataSet.deserialize_into_class">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.deserialize_into_class">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_into_class</span><span class="p">(</span>
        <span class="n">dataset_serialize_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">dataset_metadata</span><span class="p">:</span> <span class="n">Dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RasterDataSet&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We need to properly open up the dataset, if it is a subdataset, then we need</span>
<span class="sd">        to properly open that subdataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_serialize_value (Union[str, np.ndarray]):</span>
<span class="sd">                A string that represents the file path to the dataset, or a numpy array</span>
<span class="sd">                that represents the data in the dataset.</span>
<span class="sd">            dataset_metadata (Dict):</span>
<span class="sd">                A dictionary that represents the metadata needed to recreate this object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            RasterDataSet: Takes the passed in parameters and reconstructs a dataset ojbect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dataset_serialize_value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;NETCDF:&quot;</span><span class="p">):</span>
            <span class="n">dataset_serialize_value</span> <span class="o">=</span> <span class="n">dataset_serialize_value</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">impl</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impl_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NetCDF_GDALRasterDataImpl&quot;</span><span class="p">:</span>
                    <span class="n">subdataset_name</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="p">[</span><span class="s2">&quot;subdataset_name&quot;</span><span class="p">]</span>
                    <span class="k">assert</span> <span class="n">subdataset_name</span><span class="p">,</span> <span class="s2">&quot;ERROR: Subdataset name for netcdf dataset is empty or none&quot;</span>
                    <span class="n">impl</span> <span class="o">=</span> <span class="n">NetCDF_GDALRasterDataImpl</span><span class="o">.</span><span class="n">try_load_file</span><span class="p">(</span>
                        <span class="n">dataset_serialize_value</span><span class="p">,</span>
                        <span class="n">subdataset_name</span><span class="o">=</span><span class="n">subdataset_name</span><span class="p">,</span>
                        <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impl_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ENVI_GDALRasterDataImpl&quot;</span><span class="p">:</span>
                    <span class="n">impl</span> <span class="o">=</span> <span class="n">ENVI_GDALRasterDataImpl</span><span class="o">.</span><span class="n">try_load_file</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
                        <span class="mi">0</span>
                    <span class="p">]</span>
                <span class="k">elif</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impl_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;JP2_GDAL_PDR_RasterDataImpl&quot;</span><span class="p">:</span>
                    <span class="n">impl</span> <span class="o">=</span> <span class="n">JP2_GDAL_PDR_RasterDataImpl</span><span class="o">.</span><span class="n">try_load_file</span><span class="p">(</span>
                        <span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impl_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;GDALRasterDataImpl&quot;</span><span class="p">:</span>
                    <span class="n">impl</span> <span class="o">=</span> <span class="n">GDALRasterDataImpl</span><span class="o">.</span><span class="n">try_load_file</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impl_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;PDRRasterDataImpl&quot;</span><span class="p">:</span>
                    <span class="n">impl</span> <span class="o">=</span> <span class="n">PDRRasterDataImpl</span><span class="o">.</span><span class="n">try_load_file</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;impl_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NumPyRasterDataImpl&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Numpy array should not have dataset_serialize_value as string&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported implementation type: </span><span class="si">{</span><span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;impl_type&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">RasterDataSet</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">impl</span> <span class="o">=</span> <span class="n">NumPyRasterDataImpl</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">)</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">RasterDataSet</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dataset_serialize_value type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset_serialize_value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">copy_serialized_metadata_from</span><span class="p">(</span><span class="n">dataset_metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dataset</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deserializing dataset:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RasterDataSet.copy_serialized_metadata_from">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.copy_serialized_metadata_from">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_serialized_metadata_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies the metadata from the dataset_metadata dictionary into this object. This</span>
<span class="sd">        is useful when reconstructing RasterDataSet objects meta data in another process.</span>
<span class="sd">        This is needed because the user can change the in memory copy of the RasterDataSet</span>
<span class="sd">        object and so if we reconstruct this object just from the impl dataset, we would</span>
<span class="sd">        not get this changed metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serial_save_state</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;save_state&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_elem_type</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;elem_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_data_ignore_value</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data_ignore_value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_bad_bands</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bad_bands&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_wkt_spatial_ref</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wkt_spatial_ref&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_geo_transform</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;geo_transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_wavelengths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavelengths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">serial_wavelength_units</span> <span class="o">=</span> <span class="n">dataset_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serial_save_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_save_state</span><span class="p">(</span><span class="n">serial_save_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serial_elem_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elem_type</span> <span class="o">=</span> <span class="n">serial_elem_type</span>
        <span class="k">if</span> <span class="n">serial_data_ignore_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="o">=</span> <span class="n">serial_data_ignore_value</span>
        <span class="k">if</span> <span class="n">serial_bad_bands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bad_bands</span> <span class="o">=</span> <span class="n">serial_bad_bands</span>
        <span class="k">if</span> <span class="n">serial_wkt_spatial_ref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span> <span class="o">=</span> <span class="n">serial_wkt_spatial_ref</span>
            <span class="n">spatial_ref</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
            <span class="n">spatial_ref</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">serial_wkt_spatial_ref</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_ref</span> <span class="o">=</span> <span class="n">spatial_ref</span>
        <span class="k">if</span> <span class="n">serial_geo_transform</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_geo_transform</span> <span class="o">=</span> <span class="n">serial_geo_transform</span>
        <span class="k">if</span> <span class="n">serial_wavelengths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span> <span class="o">=</span> <span class="n">build_band_info_from_wavelengths</span><span class="p">(</span><span class="n">serial_wavelengths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serial_wavelength_units</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_band_unit</span> <span class="o">=</span> <span class="n">serial_wavelength_units</span></div>


<div class="viewcode-block" id="RasterDataSet.get_serialized_form">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataSet.get_serialized_form">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serialized_form</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializedForm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives a tuple that represents all of the data needed to recreate this object.</span>
<span class="sd">        The first element is this class, so we can get the deserialize_into_class function</span>
<span class="sd">        The second element is a string that represents the file path to the dataset, or a numpy array</span>
<span class="sd">        that represents the data in the dataset. The third element is a dictionary that represents</span>
<span class="sd">        the metadata needed to recreate this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">impl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_impl</span><span class="p">()</span>
        <span class="n">recreation_value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">ENVI_GDALRasterDataImpl</span><span class="p">):</span>
            <span class="n">impl_type_str</span> <span class="o">=</span> <span class="s2">&quot;ENVI_GDALRasterDataImpl&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">NetCDF_GDALRasterDataImpl</span><span class="p">):</span>
            <span class="n">impl_type_str</span> <span class="o">=</span> <span class="s2">&quot;NetCDF_GDALRasterDataImpl&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">JP2_GDAL_PDR_RasterDataImpl</span><span class="p">):</span>
            <span class="n">impl_type_str</span> <span class="o">=</span> <span class="s2">&quot;JP2_GDAL_PDR_RasterDataImpl&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">GDALRasterDataImpl</span><span class="p">):</span>
            <span class="n">impl_type_str</span> <span class="o">=</span> <span class="s2">&quot;GDALRasterDataImpl&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">PDRRasterDataImpl</span><span class="p">):</span>
            <span class="n">impl_type_str</span> <span class="o">=</span> <span class="s2">&quot;PDRRasterDataImpl&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">NumPyRasterDataImpl</span><span class="p">):</span>
            <span class="n">impl_type_str</span> <span class="o">=</span> <span class="s2">&quot;NumPyRasterDataImpl&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported implementation type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;impl_type&quot;</span><span class="p">:</span> <span class="n">impl_type_str</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="p">(</span><span class="n">NetCDF_GDALRasterDataImpl</span><span class="p">)):</span>
            <span class="c1"># If we have an NetCDF dataset, the subdataset name matters, so we</span>
            <span class="c1"># must recreate the dataset from the base file path then pass in the</span>
            <span class="c1"># subdataset name.</span>
            <span class="n">recreation_value</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">gdal_dataset</span><span class="o">.</span><span class="n">GetFileList</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="p">(</span><span class="n">GDALRasterDataImpl</span><span class="p">,</span> <span class="n">PDRRasterDataImpl</span><span class="p">)):</span>
            <span class="c1"># For GDALRasterDataImpl objects we need meta data values</span>
            <span class="c1"># for the data ignore value, wavelengths, wavelength units,</span>
            <span class="c1"># bad bands, spatial reference, geo transform, and subdataset name.</span>
            <span class="n">recreation_value</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">get_filepaths</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impl</span><span class="p">,</span> <span class="n">NumPyRasterDataImpl</span><span class="p">):</span>
            <span class="n">recreation_value</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">SerializedForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">recreation_value</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported implementation type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">impl</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;elem_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elem_type</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;data_ignore_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_ignore_value</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;bad_bands&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wkt_spatial_ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wkt_spatial_reference</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;geo_transform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_geo_transform</span><span class="p">()</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;subdataset_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subdataset_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_has_wavelengths</span><span class="p">():</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wavelengths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">band</span><span class="p">[</span><span class="s2">&quot;wavelength&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_info</span><span class="p">]</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_band_unit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wavelengths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">SerializedForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">recreation_value</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        I understand that the documentation here: https://docs.python.org/3/glossary.html#term-hashable</span>
<span class="sd">        States that &#39;A hash should remain unchanged throughout the lifetime of the object&#39;, however, for</span>
<span class="sd">        this object, we want the hash to change if the data ignore value changed, so cache&#39;s that used</span>
<span class="sd">        this dataset will use the &#39;new&#39; hashed dataset and cause computations to be redone with the</span>
<span class="sd">        new data ignore value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_ignore_value</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">RasterDataSet</span><span class="p">):</span>
            <span class="n">our_filepaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filepaths</span><span class="p">()</span>
            <span class="n">other_filepaths</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_filepaths</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">our_filepaths</span> <span class="o">!=</span> <span class="n">other_filepaths</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_ignore_value</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_data_ignore_value</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">()</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">get_bad_bands</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This class is not deep copyable. If you try to deep copy it, you will get</span>
<span class="sd">        an reference to the same object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">RasterBand</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base class mean to represent a raster band. This class is meant to be</span>
<span class="sd">    subclassed by the different types of raster bands.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">RasterDataSet</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span> <span class="o">=</span> <span class="n">dataset</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of pixels per row in the raster data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of rows of data in the raster data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the shape of the raster data set.  This is always in the order</span>
<span class="sd">        ``(height, width)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_width</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;get_data is not implemented for RasterBand, implement in subclass&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_elem_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the element-type of the raster data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_elem_type</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RasterDataSet</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the backing data set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_spatial_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMetadata</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span>
        <span class="n">spatial_metadata</span> <span class="o">=</span> <span class="n">SpatialMetadata</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">_geo_transform</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">_wkt_spatial_reference</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spatial_metadata</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_spectral_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralMetadata</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This class is not deep copyable. If you try to deep copy it, you will get</span>
<span class="sd">        an reference to the same object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>


<div class="viewcode-block" id="RasterDataBand">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataBand">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RasterDataBand</span><span class="p">(</span><span class="n">RasterBand</span><span class="p">,</span> <span class="n">Serializable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper class to represent a single band of a raster data set. This is a</span>
<span class="sd">    simple wrapper around class:RasterDataSet that also tracks a single band.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">RasterDataSet</span><span class="p">,</span> <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">band_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">band_index</span> <span class="o">&gt;=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_bands</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;band_index </span><span class="si">{</span><span class="n">band_index</span><span class="si">}</span><span class="s2"> is invalid&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">=</span> <span class="n">band_index</span>

<div class="viewcode-block" id="RasterDataBand.get_band_index">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataBand.get_band_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the 0-based index of the band in the backing data set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span></div>


<div class="viewcode-block" id="RasterDataBand.get_data">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataBand.get_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy 2D array of this band&#39;s data.</span>

<span class="sd">        The numpy array is configured such that the pixel (x, y) values are at</span>
<span class="sd">        element ``array[y][x]``.</span>

<span class="sd">        If the data-set has a &quot;data ignore value&quot; and filter_data_ignore_value</span>
<span class="sd">        is also set to True, the array will be filtered such that any element</span>
<span class="sd">        with the &quot;data ignore value&quot; will be filtered to NaN.  Note that this</span>
<span class="sd">        filtering will impact performance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="RasterDataBand.get_stats">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataBand.get_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BandStats</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns statistics of this band&#39;s data, wrapped in a class:BandStats</span>
<span class="sd">        object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">is_metadata_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;RasterDataBand&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">is_metadata_same</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>

<div class="viewcode-block" id="RasterDataBand.deserialize_into_class">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataBand.deserialize_into_class">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_into_class</span><span class="p">(</span><span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">band_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RasterDataBand&quot;</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">RasterDataSet</span><span class="o">.</span><span class="n">deserialize_into_class</span><span class="p">(</span>
            <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;dataset_serialize_value&quot;</span><span class="p">],</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">RasterDataBand</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">band_index</span><span class="p">)</span></div>


<div class="viewcode-block" id="RasterDataBand.get_serialized_form">
<a class="viewcode-back" href="../../../supporting_types.html#wiser.raster.RasterDataBand.get_serialized_form">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_serialized_form</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializedForm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives a tuple that represents all of the data needed to recreate this object.</span>
<span class="sd">        The first element is this class, so we can get the deserialize_into_class function</span>
<span class="sd">        The second element is a string that represents the file path to the dataset, or a numpy array</span>
<span class="sd">        that represents the data in the dataset. The third element is a dictionary that represents</span>
<span class="sd">        the metadata needed to recreate this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serialized_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_serialized_form</span><span class="p">()</span>
        <span class="n">serializable_class</span> <span class="o">=</span> <span class="n">serialized_form</span><span class="o">.</span><span class="n">get_serializable_class</span><span class="p">()</span>
        <span class="n">dataset_serialize_value</span> <span class="o">=</span> <span class="n">serialized_form</span><span class="o">.</span><span class="n">get_serialize_value</span><span class="p">()</span>
        <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="n">serialized_form</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;band_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span>
            <span class="s2">&quot;dataset_serializable_class&quot;</span><span class="p">:</span> <span class="n">serializable_class</span><span class="p">,</span>
            <span class="s2">&quot;dataset_serialize_value&quot;</span><span class="p">:</span> <span class="n">dataset_serialize_value</span><span class="p">,</span>
            <span class="s2">&quot;dataset_metadata&quot;</span><span class="p">:</span> <span class="n">dataset_metadata</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">SerializedForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">RasterDataDynamicBand</span><span class="p">(</span><span class="n">RasterBand</span><span class="p">,</span> <span class="n">Serializable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is meant to represent one band in a RasterDataSet that is used when</span>
<span class="sd">    batch processing. A user can specify to use the band index in the dataset or</span>
<span class="sd">    go based off of wavelength. This functionality is implemented in this class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">RasterDataSet</span><span class="p">,</span>
        <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wavelength_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wavelength_units</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">band_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">wavelength_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wavelength_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Either band_index or wavelength_value, wavelength_units, and epsilon must be provided&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">=</span> <span class="n">band_index</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">has_wavelengths</span><span class="p">(),</span> <span class="p">(</span>
                <span class="s2">&quot;Dataset must have wavelengths to use RasterDataBatchBand with &quot;</span>
                <span class="s2">&quot;wavelength_value and wavelength_units&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="o">=</span> <span class="n">wavelength_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="o">=</span> <span class="n">wavelength_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_info</span><span class="p">()</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span>
            <span class="n">epsilon_quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">find_band_near_wavelength</span><span class="p">(</span><span class="n">band_info</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">epsilon_quantity</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">=</span> <span class="n">band</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_data</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">filter_data_ignore_value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BandStats</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_info</span><span class="p">()</span>
            <span class="n">wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span>
            <span class="n">epsilon_quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">find_band_near_wavelength</span><span class="p">(</span><span class="n">band_info</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">epsilon_quantity</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_band_stats</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_metadata_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;RasterDataDynamicBand&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_band_index</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">is_metadata_same</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">_epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_wavelength_value</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_wavelength_units</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_epsilon</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">is_metadata_same</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_dataset</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_into_class</span><span class="p">(</span><span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">band_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RasterDataDynamicBand&quot;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">wiser.raster.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">RasterDataLoader</span>

        <span class="n">loader</span> <span class="o">=</span> <span class="n">RasterDataLoader</span><span class="p">()</span>
        <span class="n">wavelength_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;wavelength_value&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;wavelength_value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">wavelength_units</span> <span class="o">=</span> <span class="n">get_spectral_unit_from_any</span><span class="p">(</span><span class="n">band_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">band_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">wavelength_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wavelength_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Either band_index or wavelength_value, wavelength_units, and epsilon must be provided&quot;</span>
        <span class="c1"># TODO (Joshua G-K): Make a cleaner way of passing in the filepath if we are</span>
        <span class="c1"># coming from a RasterDataBatchBand.</span>
        <span class="c1"># Currently, if we call this function using the data from a RasterDataBatchBand,</span>
        <span class="c1"># we will have to load the dataset using the filepath which will have to be added</span>
        <span class="c1"># to band_metadata.</span>
        <span class="k">if</span> <span class="s2">&quot;dataset_serializable_class&quot;</span> <span class="ow">in</span> <span class="n">band_metadata</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;dataset_serialize_value&quot;</span> <span class="ow">in</span> <span class="n">band_metadata</span> <span class="ow">and</span> <span class="s2">&quot;dataset_metadata&quot;</span> <span class="ow">in</span> <span class="n">band_metadata</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;dataset_serialize_value and dataset_metadata must be provided if &quot;</span>
                <span class="s2">&quot;dataset_serializable_class is provided&quot;</span>
            <span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;dataset_serializable_class&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">deserialize_into_class</span><span class="p">(</span>
                <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;dataset_serialize_value&quot;</span><span class="p">],</span>
                <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;filepath&quot;</span><span class="p">],</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;dataset_metadata&quot;</span> <span class="ow">in</span> <span class="n">band_metadata</span><span class="p">:</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">copy_serialized_metadata_from</span><span class="p">(</span><span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;dataset_metadata&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">RasterDataDynamicBand</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">band_index</span><span class="p">,</span> <span class="n">wavelength_value</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_serialized_form</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializedForm</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives a tuple that represents all of the data needed to recreate this object.</span>
<span class="sd">        The first element is this class, so we can get the deserialize_into_class function</span>
<span class="sd">        The second element is a string that represents the file path to the dataset, or a numpy array</span>
<span class="sd">        that represents the data in the dataset. The third element is a dictionary that represents</span>
<span class="sd">        the metadata needed to recreate this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serialized_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="o">.</span><span class="n">get_serialized_form</span><span class="p">()</span>
        <span class="n">serializable_class</span> <span class="o">=</span> <span class="n">serialized_form</span><span class="o">.</span><span class="n">get_serializable_class</span><span class="p">()</span>
        <span class="n">dataset_serialize_value</span> <span class="o">=</span> <span class="n">serialized_form</span><span class="o">.</span><span class="n">get_serialize_value</span><span class="p">()</span>
        <span class="n">dataset_metadata</span> <span class="o">=</span> <span class="n">serialized_form</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;band_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span>
            <span class="s2">&quot;wavelength_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span><span class="p">,</span>
            <span class="s2">&quot;wavelength_units&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span><span class="p">,</span>
            <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">,</span>
            <span class="s2">&quot;dataset_serializable_class&quot;</span><span class="p">:</span> <span class="n">serializable_class</span><span class="p">,</span>
            <span class="s2">&quot;dataset_serialize_value&quot;</span><span class="p">:</span> <span class="n">dataset_serialize_value</span><span class="p">,</span>
            <span class="s2">&quot;dataset_metadata&quot;</span><span class="p">:</span> <span class="n">dataset_metadata</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">SerializedForm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RasterDataBatchBand</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is meant to represent the parameters needed to open a band in a batch</span>
<span class="sd">    for batch processing. This is why you can&#39;t actually get the band data from it</span>
<span class="sd">    because it only has the information to open a band and not the band itself.</span>

<span class="sd">    Args:</span>
<span class="sd">        folderpath: The folder path to the datasets band_index: The band index</span>
<span class="sd">                    to open (If this is set, wavelength_value, wavelength_units,</span>
<span class="sd">                    and epsilon shouldn&#39;t be)</span>
<span class="sd">        wavelength_value:   The wavelength value to open (If this is set, band_index</span>
<span class="sd">                            shouldn&#39;t be)</span>
<span class="sd">        wavelength_units:   The units of the wavelength value (If this is set,</span>
<span class="sd">                            band_index shouldn&#39;t be)</span>
<span class="sd">        epsilon:    The epsilon value to use when finding the band (If this is set,</span>
<span class="sd">                    band_index shouldn&#39;t be)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">folderpath</span><span class="p">,</span>
        <span class="n">band_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wavelength_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wavelength_units</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_folderpath</span> <span class="o">=</span> <span class="n">folderpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span> <span class="o">=</span> <span class="n">band_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span> <span class="o">=</span> <span class="n">wavelength_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span> <span class="o">=</span> <span class="n">wavelength_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_folderpath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folderpath</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavelength_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_wavelength_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_epsilon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deserialize_into_class</span><span class="p">(</span><span class="n">folderpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">band_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RasterDataBatchBand&quot;</span><span class="p">:</span>
        <span class="n">band_index</span> <span class="o">=</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;band_index&quot;</span><span class="p">]</span>
        <span class="n">wavelength_value</span> <span class="o">=</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;wavelength_value&quot;</span><span class="p">]</span>
        <span class="n">wavelength_units</span> <span class="o">=</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;wavelength_units&quot;</span><span class="p">]</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">band_metadata</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">RasterDataBatchBand</span><span class="p">(</span><span class="n">folderpath</span><span class="p">,</span> <span class="n">band_index</span><span class="p">,</span> <span class="n">wavelength_value</span><span class="p">,</span> <span class="n">wavelength_units</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_serialized_form</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializedForm</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;band_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_band_index</span><span class="p">,</span>
            <span class="s2">&quot;wavelength_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_value</span><span class="p">,</span>
            <span class="s2">&quot;wavelength_units&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wavelength_units</span><span class="p">,</span>
            <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">SerializedForm</span><span class="p">(</span><span class="n">RasterDataDynamicBand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folderpath</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_truecolor_bands</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">RasterDataSet</span><span class="p">,</span>
    <span class="n">red</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">RED_WAVELENGTH</span><span class="p">,</span>
    <span class="n">green</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">GREEN_WAVELENGTH</span><span class="p">,</span>
    <span class="n">blue</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">BLUE_WAVELENGTH</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function looks for bands in the dataset that are closest to the</span>
<span class="sd">    visible-light spectral bands.</span>

<span class="sd">    If a band cannot be found for red, green or blue wavelengths, the function</span>
<span class="sd">    returns None.  Similarly, if the dataset doesn&#39;t specify wavelengths for</span>
<span class="sd">    bands, the function returns None.</span>

<span class="sd">    If bands are found for all of the red, green and blue wavelengths, then the</span>
<span class="sd">    function returns a (red_band_index, grn_band_index, blu_band_index) triple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">has_wavelengths</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">bands</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">band_list</span><span class="p">()</span>
    <span class="n">red_band</span> <span class="o">=</span> <span class="n">find_band_near_wavelength</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span>
    <span class="n">green_band</span> <span class="o">=</span> <span class="n">find_band_near_wavelength</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">green</span><span class="p">)</span>
    <span class="n">blue_band</span> <span class="o">=</span> <span class="n">find_band_near_wavelength</span><span class="p">(</span><span class="n">bands</span><span class="p">,</span> <span class="n">blue</span><span class="p">)</span>
    <span class="c1"># If that didn&#39;t work, report None</span>
    <span class="k">if</span> <span class="n">red_band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">green_band</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">blue_band</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">red_band</span><span class="p">,</span> <span class="n">green_band</span><span class="p">,</span> <span class="n">blue_band</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_display_bands</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">RasterDataSet</span><span class="p">,</span>
    <span class="n">red</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">RED_WAVELENGTH</span><span class="p">,</span>
    <span class="n">green</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">GREEN_WAVELENGTH</span><span class="p">,</span>
    <span class="n">blue</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span> <span class="o">=</span> <span class="n">BLUE_WAVELENGTH</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DisplayBands</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This helper function figures out which band(s) to use for displaying the</span>
<span class="sd">    specified raster dataset.  The return-value will be either a 3-tuple or a</span>
<span class="sd">    1-tuple of band indexes; the former is returned for RGB display of a</span>
<span class="sd">    dataset, and the latter is returned for a grayscale display of a dataset.</span>

<span class="sd">    The function operates as follows:</span>

<span class="sd">    1)  If the dataset specifies default display bands, these are returned.</span>
<span class="sd">        Note that a dataset&#39;s default display bands may specify 3 bands for RGB</span>
<span class="sd">        display, or 1 band for grayscale display.</span>
<span class="sd">    2)  Otherwise, if the dataset has frequency bands that correspond to the</span>
<span class="sd">        frequencies/wavelengths perceived by the human eye, these are returned.</span>
<span class="sd">    3)  Otherwise, if the dataset has at least three bands, then the first,</span>
<span class="sd">        second and third bands are used as RGB display bands.  If the dataset</span>
<span class="sd">        has fewer than three bands, the first band is used as the grayscale</span>
<span class="sd">        display band.</span>

<span class="sd">    The definitions of &quot;red&quot;, &quot;green&quot;, and &quot;blue&quot; wavelengths can be specified</span>
<span class="sd">    as optional arguments to this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># See if the raster data-set specifies display bands, and if so, use them</span>
    <span class="n">display_bands</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">default_display_bands</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">display_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">display_bands</span>

    <span class="c1"># Try to find bands based on what is close to visible spectral bands</span>
    <span class="n">display_bands</span> <span class="o">=</span> <span class="n">find_truecolor_bands</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">display_bands</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">display_bands</span>

    <span class="c1"># If that didn&#39;t work, just choose the first bands</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">num_bands</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># We have at least 3 bands, so use those.</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have fewer than 3 bands, so just use one band in grayscale mode.</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>  <span class="c1"># Need the comma to interpret as a tuple, not arithmetic.</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Extending WISER</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins.html">WISER Plugins Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ctxmenu_plugins.html">Context-Menu Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../toolsmenu_plugins.html">Tools-Menu Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ui_plugins.html">GUI Plugins in WISER</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bandmath_plugins.html">Band-Math Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugin_dependencies.html">Plugin Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wiser_state.html">Accessing and Modifying WISER State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../supporting_types.html">Supporting Types</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2021, California Institute of Technology.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>